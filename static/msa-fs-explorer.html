<link rel="import" href="/msa/msa.html"></link>
<link rel="import" href="msa-fs.html"></link>
<link rel="import" href="msa-fs-cascade.html"></link>
<link rel="import" href="msa-fs-dir-viewer.html"></link>
<link rel="import" href="/utils/msa-utils-popup.html"></link>
<link rel="import" href="/user/msa-user-login.html"></link>
<script src="/fs/prismjs/prism.js"></script>
<link rel="stylesheet" href="/fs/prismjs/themes/prism-okaidia.css" />
<style>
msa-fs-explorer {
	display: flex;
	flex-direction: column;
	padding: 20px;
}
msa-fs-explorer .row {
	display: flex;
	flex-direction: row;
}
msa-fs-explorer .col {
	display: flex;
	flex-direction: column;
}
msa-fs-explorer .fill {
	flex: 1;
	align-self: stretch;
}
msa-fs-explorer .border {
	margin: 2px;
	border: 1px solid grey;
}
msa-fs-explorer .viewer {
	/* padding: 5px; */
	justify-content: center;
	align-items: center;
}
msa-fs-explorer .viewer > * {
	margin: 0;
}
</style>
<!-- template -->
<template id="msa-fs-explorer">
	<div class="col">
		<div>Path:
			<input class="path" type="text" size="80" />
			<button class="go">GO</button>
			<button class="back">Back</button>
		</div>
		<br/>
		<div>
			<button class="upload">Upload</button>
			<button class="download">Download</button>
			<button class="remove">Remove</button>
			<button class="mkdir">Create directory</button>
			<button class="edit">Edit</button>
			<button class="save">Save</button>
		</div>
		<br/>
		<div class="row">
			<msa-fs-cascade class="cascade border" request-server="false" style="width:200px; display:block"></msa-fs-cascade>
			<div class="viewer fill border row"></div>
		</div>
	</div>
</template>
<script>
(function() {

	var join = MsaFs.join,
		dirname = MsaFs.dirname,
		parseUrlArgs = Msa.parseUrlArgs

	// global input file
	var fileInput = document.createElement("input")
	fileInput.type = "file"
	fileInput.setAttribute("multiple", true)
//	fileInput.cssText = "position:absolute; top:-1000px; left:-1000px;"
	fileInput.onchange = function() {
		this.holder.upload(this.files)
	}
	//document.body.appendChild(fileInput)

	// methods
	var explorerMethods = {}

	explorerMethods.getRootPath = function() {
		return this.getAttribute("root-path") || ""
	}
	explorerMethods.getPath = function() {
		var path = this.getAttribute("path") || "/"
		return join(this.getRootPath(), path)
	}
	explorerMethods.getRequestServer = function() {
		return this.getAttribute("request-server") !== "false"
	}
	explorerMethods.getBaseUrl = function() {
		return this.getAttribute("base-url") || "/fs"
	}
	explorerMethods.getSyncUrl = function() {
		return this.getAttribute("sync-url") === "true"
	}

	explorerMethods.setPath = function(path) {
		this.Q(".path").value = path
		this.setAttribute("path", path)
		if(this.getSyncUrl())
			window.history.replaceState(null, null, join(this.getBaseUrl(), "ui", path))
	}

	// REQUEST

	var onbadperm = function(explorer) {
		return function(){
			explorer.innerHTML = "<msa-user-login unauthorized></msa-user-login>"
		}
	}

	// get file metadata
	explorerMethods.getMetadata = function(path, next) {
		var url = join(this.getBaseUrl(), 'meta', path)
		Msa.get(url, {
			onsuccess: next,
			onbadperm: onbadperm(this)
		})
	}

	// get dir content from server
	explorerMethods.listFiles = function(path, next, refreshCache) {
		var fileCache = this.fileCache
		var cache = fileCache[path]
		if(cache && refreshCache!==true) next(cache)
		else {
			var explorer = this
			var url = join(explorer.getBaseUrl(), 'list', path)
			Msa.get(url, {
				onsuccess: function(files){
					fileCache[path] = files
					next(files)
				},
				onbadperm: onbadperm(this)
			})
		}
	}

	// remove a file
	explorerMethods.remove = function(names) {
		if(!names) names = this.getSelectedNames()
		var nbDeleting = names.length
		names.forEach(name => {
			var url = join(this.getBaseUrl(), 'dir', dirname(this.getPath()), name)
			Msa.delete(url, () => {
				if(--nbDeleting===0)
					this.goBack()
			})
		})
	}

	// create a directory
	explorerMethods.mkdir = function(name) {
		if(!name) return
		var url = join(this.getBaseUrl(), 'dir', this.getPath(), name)
		var explorer = this
		Msa.post(url, function(res){
			explorer.refresh()
		})
	}

	// upload a file
	explorerMethods.upload = function(files) {
		var explorer = this
		var url = join(this.getBaseUrl(), 'data', this.getPath())
		MsaFs.postFile(files, url, function(){
			explorer.refresh()
		})
	}

	// go to directory
	explorerMethods.goTo = function(path) {
		// if path is not provided, use path input's one
		if(path===undefined) path = this.Q(".path").value
		this.showFile(path)
	}

	// go to parent directory
	explorerMethods.goBack = function() {
		var path = this.getPath()
		this.goTo(dirname(path))
	}

	// refresh
	explorerMethods.refresh = function(){
		this.showFile(this.getPath())
	}

	// show file in cascade and viewer
	explorerMethods.showFile = function(path) {
		var explorer = this
		this.getMetadata(path, function(md) {
			explorer.showFileInCascade(path, md)
			explorer.showFileInViewer(path, md)
		})
	}

	// show dir in cascade (or parent dir, if type is file)
	explorerMethods.showFileInCascade = function(path, md) {
		if(md.type!=="dir" && path!=='/') path = dirname(path)
		var explorer = this
		this.listFiles(path, function(files){
			explorer.showDirInCascade(path, files)
		})
	}

	// show directory in cascade
	explorerMethods.showDirInCascade = function(path, files) {
		var cascade = this.Q(".cascade")
		cascade.setAttribute('path', path)
		cascade.showFiles(files)
	}

	// VIEWER

	// clear viewer
	explorerMethods.clearViewer = function(path, files) {
		this.Q(".viewer").innerHTML = ""
	}

	// show file in viewer (whatever its type)
	explorerMethods.showFileInViewer = function(path, md) {
		this.setPath(path)
		this.clearViewer()
		var explorer = this
		if(md.type=="dir"){
			this.listFiles(path, function(files){
				explorer.showDirInViewer(path, files)
			})
		} else if(md.type=="file"){
			var mime = md.mime
			var mime1 = mime.split('/')[0]
			if(mime1==='image'){
				this.showImageInViewer(path)
			} else if(mime1==='video'){
				this.showVideoInViewer(path, mime)
			} else {
				this.showTextInViewer(path)
			}
		}
	}

	// show dir in viewer
	explorerMethods.showDirInViewer = function(path, files) {
		this.viewerType = "dir"
		this.clearViewer()
		var explorer = this
		var viewer = this.Q(".viewer")
		var dirViewer = document.createElement("msa-fs-dir-viewer")
		dirViewer.classList.add('fill')
		dirViewer.setAttribute("path", path)
		dirViewer.setAttribute("request-server", "false")
		dirViewer.addEventListener("dblselect", function(evt){
			var path = evt.detail.path, file = evt.detail.file
			if(file.type==='dir')
				explorer.goTo(join(path, file.name))
		})
		dirViewer.showFiles(files)
		viewer.appendChild(dirViewer)
	}

	// show image in viewer
	explorerMethods.showImageInViewer = function(path){
		this.viewerType = "img"
		this.clearViewer()
		var viewer = this.Q(".viewer")
		var img = document.createElement("img")
		img.src = join(this.getBaseUrl(), 'data', path)
		viewer.appendChild(img)
	}

	// show video in viewer
	explorerMethods.showVideoInViewer = function(path, type){
		this.viewerType = "video"
		this.clearViewer()
		var viewer = this.Q(".viewer")
		var video = document.createElement("video")
		video.src = join(this.getBaseUrl(), 'data', path)
		video.setAttribute('type', type)
		video.setAttribute('controls', true)
		viewer.appendChild(video)
	}

	// show text in viewer
	explorerMethods.showTextInViewer = function(path){
		this.viewerType = "text"
		this.clearViewer()
		var viewer = this.Q(".viewer")
		var url = join(this.getBaseUrl(), 'data', path)
		Msa.get(url, { parseRes:false }, function(text){
			// create pre element
			var pre = document.createElement("pre")
			pre.classList.add('fill')
			// check if this is code, and determine language
			var ext = path.split('.').pop()
			if(["js", "css", "html", "json", "xml"].indexOf(ext) !== -1) var lang = ext
			if(lang) pre.classList.add("language-" + lang)
			pre.textContent = text
			// highlight
			if(window.Prism) Prism.highlightElement(pre, true)
			viewer.appendChild(pre)
		})
	}

	// edit
	explorerMethods.edit = function(){
		if(this.viewerType !== "text") return
		this.editing = true
		var pre = this.Q(".viewer pre")
		pre.setAttribute("contenteditable", true)
		pre.onkeydown = (evt) => {
			if (evt.keyCode === 13) {
				document.execCommand('insertHTML', false, '\n');
				return false; 
			}
		}
	}

	// save
	explorerMethods.save = function(){
		if(!this.editing) return
		var pre = this.Q(".viewer pre")
		content = pre.textContent
		var url = join(this.getBaseUrl(), 'data', this.getPath())
		Msa.post(url, {body:content}, function(res){
			explorer.refresh()
		})
	}

	// get selected file names from cascade
	explorerMethods.getSelectedNames = function() {
		// files from cascade
		var cascade = this.Q(".cascade")
		var files = cascade.getSelectedFiles()
		var names = files.map(function(file){ return file.name })
		// files from dir viewer (if any)
		var dirViewer = this.Q(".viewer msa-fs-dir-viewer")
		if(dirViewer){
			var dirFiles = dirViewer.getSelectedFiles()
			names = names.concat(dirFiles.map(function(file){ return file.name }))
		}
		return names
	}

	// download a file
	explorerMethods.download = function(names) {
		if(!names) names = this.getSelectedNames()
		if(!names) {
			var holder = this
			names.forEach(function(name){
				var href = name, path = dirname(holder.getPath())
				if(path) href = join(path, name)
				href = join(holder.getBaseUrl(), 'data', href)
				MsaFs.download(href)
			})
		} else {
			var href = join(this.getBaseUrl(), 'data', this.getPath())
			MsaFs.download(href)
		}
	}

	// actions
	var explorerActions = []

	explorerActions.push({ el:".path", evt:"keypress", act:function(e) {
		if(e.which == 13) this.goTo()
	}})
	explorerActions.push({ el:".go", evt:"click", act:function() {
		this.goTo()
	}})
	explorerActions.push({ el:".back", evt:"click", act:function() {
		this.goBack()
	}})
	explorerActions.push({ el:".upload", evt:"click", act:function() {
		fileInput.holder = this
		fileInput.click()
	}})
	explorerActions.push({ el:".download", evt:"click", act:function() {
		this.download()
	}})
	explorerActions.push({ el:".remove", evt:"click", act:function() {
		var holder = this
		var files = this.getSelectedNames()
		MsaUtils.createConfirmPopup("Are you sure you want to remove these files ? " + files, function(){
			holder.remove()
		})
	}})
	explorerActions.push({ el:".mkdir", evt:"click", act:function() {
		var holder = this
		MsaUtils.createInputPopup("Enter the name of the directory to create", function(name){
			holder.mkdir(name)
		})
	}})
	explorerActions.push({ el:".edit", evt:"click", act:function() {
		this.edit()
	}})
	explorerActions.push({ el:".save", evt:"click", act:function() {
		this.save()
	}})
	explorerActions.push({ el:".cascade", evt:"select", act:function(evt){
		var detail = evt.detail, md = detail.file
		this.showFileInViewer(join(detail.path, md.name), md)
	}})
	explorerActions.push({ el:".cascade", evt:"dblselect", act:function(evt){
		var path = evt.detail.path, file = evt.detail.file
		if(file.type==='dir')
			this.goTo(join(path, file.name))
	}})

	// register msa-fs-explorer
	Msa.registerElement("msa-fs-explorer", {
		template: "#msa-fs-explorer",
		oncreate: function() {

			// attributes ////////////////////////////////////////
			this.editing = false
			this.viewerType = null
			this.fileCache = {}

			// methods //////////////////////////////////////////
			this.Q = Msa.Q
			Object.assign(this, explorerMethods)
			Msa.addActions(this, explorerActions)
		},
		onattach: function() {
			if(this.getRequestServer()) {
				if(this.getSyncUrl())
					// TODO: improve this
					var path = window.location.pathname.slice(this.getBaseUrl().length+3)
				else
					var path = this.getPath()
				this.goTo(path)
			}
		}
	})
})()
</script>
