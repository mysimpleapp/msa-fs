<link rel="import" href="/msa/msa.html"></link>
<link rel="import" href="msa-fs.html"></link>
<style>
msa-fs-cascade {
	display: block;
	padding: 3px 0 3px 0;
	margin: 0;
}
msa-fs-cascade .file {
	cursor: pointer;
	padding-left: 3px;
}
msa-fs-cascade .file:hover {
	background-color: #EEF;
}
msa-fs-cascade .file.selected {
	background-color: #DDF;
}
msa-fs-cascade .file svg {
	width: 16px;
	height: 16px;
	padding: 0 3px 0 3px;
}
</style>
<!-- template -->
<script>
(function() {

	var join = MsaFs.join,
		parseUrlArgs = Msa.parseUrlArgs

	// methods
	var cascadeMethods = {}

	cascadeMethods.getRootPath = function() {
		return this.getAttribute("root-path") || ""
	}
	cascadeMethods.getPath = function() {
		var path = this.getAttribute("path") || "/"
		return join(this.getRootPath(), path)
	}
	cascadeMethods.getRequestServer = function() {
		return this.getAttribute("request-server") !== "false"
	}
	cascadeMethods.getBaseUrl = function() {
		return this.getAttribute("base-url") || "/fs/api"
	}

	cascadeMethods.addPath = function(subPath) {
		if(this.getRequestServer()) {
			this.listFiles()
			var path = this.getAttribute("path")
			this.setAttribute("path", join(path, subPath))
		}
	}

	// list files from server
	cascadeMethods.listFiles = function() {
		var cascade = this
		var url = join(explorer.getBaseUrl(), path)
		Msa.get(url, function(files){
			cascade.showFiles(files)
		})
	}

	// show files in element
	cascadeMethods.showFiles = function(files) {
		this.innerHTML = ""
		var cascade = this
		files.forEach(function(file) {
			var type = file.type, name = file.name
			var fileDom = document.createElement("div")
			fileDom.classList.add("file")
			fileDom.innerHTML = "<svg><use xlink:href='#msa-fs-"+type+"'></use></svg><span>" + name + "</span>"
			fileDom.file = file
			fileDom.onclick = function(evt) {
				if(!this.classList.contains("selected")) {
					if (!evt.ctrlKey) cascade.clearSelection()
					cascade.dispatchEvent(new CustomEvent('select', {detail:{path:cascade.getPath(), file:file}}))
				}
				this.classList.toggle("selected")
			}
			fileDom.ondblclick = function() {
				cascade.dispatchEvent(new CustomEvent('dblselect', {detail:{path:cascade.getPath(), file:file}}))
				if(file.type=="dir") cascade.addPath(file.name)
			}
			cascade.appendChild(fileDom)
		})
	}

	cascadeMethods.clearSelection = function() {
		var selecteds = this.querySelectorAll(".selected")
		for(var i=0, len=selecteds.length; i<len; ++i) {
			selecteds[i].classList.remove("selected")
		}
	}

	cascadeMethods.getSelectedFiles = function() {
		var files = []
		var selecteds = this.querySelectorAll(".selected")
		for(var i=0, len=selecteds.length; i<len; ++i)
			files.push(selecteds[i].file)
		return files
	}

	// register msa-fs-explorer
	Msa.registerElement("msa-fs-cascade", {
		oncreate: function() {
			Object.assign(this, cascadeMethods)
		},
		onattach: function() {
			if(this.getRequestServer()) this.listFiles()
		}
	})
})()
</script>
